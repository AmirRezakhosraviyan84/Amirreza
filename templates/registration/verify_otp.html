<h2 class="text-center mb-3">تایید شماره موبایل</h2>

{% if error %}
<div style="color:red" class="text-center">{{ error }}</div>
{% endif %}

<div class="text-center mb-3">
    <span id="countdown">60</span> ثانیه تا انقضای کد
</div>

<!-- فرم OTP -->
<form id="otpForm" class="text-center">
    {% csrf_token %}
    <input type="hidden" id="userId" value="{{ user.id }}">
    <div class="otp-inputs d-flex justify-content-center gap-2 mb-3">
        <input type="text" maxlength="1" class="otp-inputbar form-control">
        <input type="text" maxlength="1" class="otp-inputbar form-control">
        <input type="text" maxlength="1" class="otp-inputbar form-control">
        <input type="text" maxlength="1" class="otp-inputbar form-control">
        <input type="text" maxlength="1" class="otp-inputbar form-control">
        <input type="text" maxlength="1" class="otp-inputbar form-control">
    </div>
    <button type="button" id="verifyOtpBtn" class="btn btn-primary">تایید</button>
</form>

<form method="GET" action="{% url 'resend_otp' user_id=user.id %}" class="text-center mt-2">
    <button id="resendBtn" type="submit" disabled class="btn btn-secondary">ارسال دوباره کد</button>
</form>

<div id="errmsg" class="text-center text-danger mt-2"></div>

<script>
// Timer
let countdownElement = document.getElementById('countdown');
let resendBtn = document.getElementById('resendBtn');
let timeLeft = 60;

let timer = setInterval(() => {
    if(timeLeft <= 0){
        clearInterval(timer);
        countdownElement.textContent = "کد منقضی شد";
        resendBtn.disabled = false;
    } else {
        countdownElement.textContent = timeLeft;
        timeLeft--;
    }
}, 1000);

// OTP input auto-focus
const otpInputs = document.querySelectorAll('.otp-inputbar');
otpInputs.forEach((input, index) => {
    input.addEventListener('input', () => {
        if(input.value.length === 1 && index < otpInputs.length - 1){
            otpInputs[index + 1].focus();
        }
    });
    input.addEventListener('keydown', (e) => {
        if(e.key === "Backspace" && input.value === "" && index > 0){
            otpInputs[index - 1].focus();
        }
    });
});

// Verify OTP
document.getElementById('verifyOtpBtn').addEventListener('click', function(e){
    e.preventDefault();
    const userId = document.getElementById('userId').value;
    let code = Array.from(otpInputs).map(i => i.value).join('');

    if(code.length !== 6){
        document.getElementById('errmsg').textContent = "لطفاً کد ۶ رقمی را کامل وارد کنید.";
        return;
    }

    fetch("/accounts/verify-otp/" + userId + "/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: "code=" + encodeURIComponent(code)
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            window.location.href = "{% url 'signup' %}";
        } else {
            document.getElementById('errmsg').textContent = data.error;
        }
    })
    .catch(err => {
        console.error(err);
        document.getElementById('errmsg').textContent = "خطا در ارتباط با سرور.";
    });
});
</script>


<script>
$(".otp-inputbar").keypress(function (e) {
    if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
        $("#errmsg").html("Digits Only").show().fadeOut("slow");
        return false;
    }
});
$(".otp-inputbar").on("keyup keydown keypress", function (e) {
    if ($(this).val()) {
        $(this).next().focus();
    }
    var KeyID = e.keyCode;
    switch (KeyID) {
        case 8:
            $(this).val("");
            $(this).prev().focus();
            break;
        case 46:
            $(this).val("");
            $(this).prev().focus();
            break;
        default:
            break;
    }
});</script>

<style>
.otp-inputbar {
    width: 40px;
    height: 45px;
    text-align: center;
    font-size: 20px;
}
@import url('https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900&display=swap');

button:focus,
input:focus{
  outline: none;
  box-shadow: none;
}
a,
a:hover{
  text-decoration: none;
}

body{
  font-family: 'Roboto', sans-serif;
}

/*------------------  */
.otp-form-group{
    display: flex;
    align-items: center;
    justify-content: center;
}
.otp-inputbar{
    width: 50px;
    height: 50px;
    border-radius: 15px;
    text-align: center;
    margin-right: 10px;
    font-size: 16px;
    color: #333;
}
#errmsg
{
color: red;
}
</style>
