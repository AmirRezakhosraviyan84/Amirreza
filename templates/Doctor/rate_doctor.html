{% extends "_base.html" %}
{%load static%}
  <link rel="stylesheet" href="{% static 'css/style.css' %}?v=1">
{% block page_title %}doctor_rating{% endblock page_title %}

{% block content %}

  <div class="container">
    <div class="card">
      <div class="doctor-header">
        <div class="doctor-avatar">
          <img src="{{ doctor.image.url }}" alt="{{ doctor.name }}">
        </div>
        <div class="doctor-info">
          <div class="doctor-name">{{ doctor.name }}</div>
          <div class="doctor-specialty">{{ doctor.specialty }}</div>
        </div>
        <div style="text-align:left">
          <!-- Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù„ÙˆÚ¯Ùˆ ÛŒØ§ Ú†ÛŒØ²ÛŒ Ø¨Ø°Ø§Ø±ÛŒ -->
        </div>
      </div>

      <div class="card-body">
        <!-- SUMMARY -->
        <div class="summary">
          <div class="rating-top">
            <div class="avg-score">
              <div class="score" id="avgScore">{{ avg_rating|default:"0.0" }}</div>
              <div class="count">{{ total_reviews|default:"0" }} Ú©Ø§Ø±Ø¨Ø±</div>
            </div>
            <div class="stars-row" aria-hidden="true">
              <!-- 5 Ø³ØªØ§Ø±Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† -->
              {% for i in "12345" %}
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .587l3.668 7.431L23.6 9.75l-5.4 5.26L19.8 24 12 19.897 4.2 24l1.6-8.99L.4 9.75l7.932-1.732z"/></svg>
              {% endfor %}
            </div>
          </div>

          <div class="criteria-list" id="criteriaList">
            {% comment %} Ù‡Ø±ÛŒÚ© Ø§Ø² Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§: label, avg_value (Ù…Ø«Ù„Ø§Ù‹ 4.85) Ùˆ Ø¯Ø±ØµØ¯ Ù¾Ø± Ø¨ÙˆØ¯Ù† Ù†ÙˆØ§Ø± {% endcomment %}
            {% for crit in criteria %}
            <div class="crit">
              <div class="label">{{ crit.label }}</div>
              <div class="progress-wrap">
                <div class="progress">
                  <i style="width:{{ crit.percent }}%"></i>
                </div>
              </div>
              <div class="value">{{ crit.value }}</div>
            </div>
            {% endfor %}
          </div>

          <div class="summary-stats">
            <div class="item">
              <div class="big">{{ recommend_percent|default:"0" }}%</div>
              <div>Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
            </div>
            <div style="width:1px;background:#f0f2f7;height:42px;margin-inline:6px;border-radius:2px"></div>
            <div class="item">
              <div class="big">{{ avg_wait_label|default:"Û±Ûµ-Û° Ø¯Ù‚ÛŒÙ‚Ù‡" }}</div>
              <div>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø±</div>
            </div>
          </div>
        </div>

        <!-- FORM -->
        <form class="review-form" method="post" action="{% url 'doctor-review' doctor.id %}">
          {% csrf_token %}
          <div>
            <div class="section-title">Ø¨Ù‡ ØªØ¬Ø±Ø¨ÛŒØ§ØªØªØ§Ù† Ø§Ø² Ù†ÙˆØ¨Øª Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ú†Ù‡ Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ*</div>
            <div class="overall-stars" style="justify-content:flex-start;gap:12px;margin-top:8px">
              <div class="star-row" role="radiogroup" aria-label="overall rating">
                {% for val in "54321" %}
                  <input id="overall-{{ val }}" type="radio" name="overall" value="{{ val }}">
                  <label for="overall-{{ val }}" title="{{ val }} Ø³ØªØ§Ø±Ù‡">
                    <!-- star svg -->
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 .587l3.668 7.431L23.6 9.75l-5.4 5.26L19.8 24 12 19.897 4.2 24l1.6-8.99L.4 9.75l7.932-1.732z"/>
                    </svg>
                  </label>
                {% endfor %}
              </div>
              <small id="overallLabel" style="color:var(--muted)">{{ overall_text|default:"Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ" }}</small>
            </div>
          </div>

          <div style="margin-top:14px;border-top:1px solid #f3f6fa;padding-top:12px">
            <div class="section-title">Ø¢ÛŒØ§ Ø¯Ú©ØªØ± Ø±Ø§ Ø¨Ù‡ Ø³Ø§ÛŒØ± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ</div>
           <div style="display:flex;gap:10px;margin-top:8px">
            <input type="radio" name="recommend_radio" id="recYesInput" value="yes" style="display:none">
            <input type="radio" name="recommend_radio" id="recNoInput" value="no" style="display:none">
            <button type="button" class="btn ghost" id="recYes" onclick="setRecommend(true)">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ù… ğŸ‘</button>
             <button type="button" class="btn ghost" id="recNo" onclick="setRecommend(false)">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ù… ğŸ‘</button>
               <input type="hidden" name="recommend" id="recommendInput" value="">
                   </div>      
          </div>

          <div style="margin-top:14px;border-top:1px solid #f3f6fa;padding-top:12px">
            <div class="section-title">Ø¨Ù‡ Ù‡Ø± Ú©Ø¯Ø§Ù… Ø§Ø² Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ú†Ù‡ Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ</div>
            <div class="criteria-rate">
              {% for crit in criteria %}
              <div class="criteria-item">
                <div style="flex:1">{{ crit.label }}</div>
                <div class="stars-inline" role="radiogroup" aria-label="{{ crit.label }}">
                  {% for s in "54321" %}
                    <input id="crit-{{ forloop.parentloop.counter }}-{{ s }}" name="crit_{{ forloop.parentloop.counter }}" type="radio" value="{{ s }}">
                    <label for="crit-{{ forloop.parentloop.counter }}-{{ s }}">
                      <svg viewBox="0 0 24 24"><path d="M12 .587l3.668 7.431L23.6 9.75l-5.4 5.26L19.8 24 12 19.897 4.2 24l1.6-8.99L.4 9.75l7.932-1.732z"/></svg>
                    </label>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>

          <div style="margin-top:14px;border-top:1px solid #f3f6fa;padding-top:12px">
            <div class="section-title">Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø´Ù…Ø§ Ø¯Ø± Ù…Ø·Ø¨ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨ÙˆØ¯ØŸ*</div>
            <div class="radio-grid">
              <div class="radio-card">
                <input type="radio" id="t1" name="wait_time" value="0-15">
                <label for="t1">0-15 Ø¯Ù‚ÛŒÙ‚Ù‡</label>
              </div>
              <div class="radio-card">
                <input type="radio" id="t2" name="wait_time" value="15-45">
                <label for="t2">Û±Ûµ-Û´Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡</label>
              </div>
              <div class="radio-card">
                <input type="radio" id="t3" name="wait_time" value="45-90">
                <label for="t3">Û´Ûµ-Û¹Û° Ø¯Ù‚ÛŒÙ‚Ù‡</label>
              </div>
              <div class="radio-card">
                <input type="radio" id="t4" name="wait_time" value="90+">
                <label for="t4">Ø¨ÛŒØ´ Ø§Ø² Û¹Û° Ø¯Ù‚ÛŒÙ‚Ù‡</label>
              </div>
            </div>
          </div>

          <div style="margin-top:14px;border-top:1px solid #f3f6fa;padding-top:12px">
            <div class="section-title">Ø¹Ù„Øª Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ø´Ù…Ø§ Ú†Ù‡ Ø¨ÙˆØ¯ØŸ</div>
            <select name="reason" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e7ecf6">
              <option value="">Ú¯Ø²ÛŒÙ†Ù‡ Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
              {% for r in reasons %}
              <option value="{{ r.id }}">{{ r.label }}</option>
              {% endfor %}
            </select>
          </div>

          <div style="margin-top:14px">
            <div class="section-title">ØªØ¬Ø±Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø² Ø§ÛŒÙ† Ù†ÙˆØ¨Øª Ú†Ø·ÙˆØ± Ø¨ÙˆØ¯ØŸ</div>
            <textarea name="comment" class="form-control" placeholder="Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
            <div style="margin-top:10px;display:flex;align-items:center;gap:12px">
              <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" name="anonymous"> Ø§Ø±Ø³Ø§Ù„ Ù†Ø¸Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø¯ Ù†Ø§Ø´Ù†Ø§Ø³</label>
            </div>
          </div>

         <div class="submit-row">
    <div style="color:var(--muted);font-size:0.92rem">Ø¨Ø§ Ø«Ø¨Øª Ù†Ø¸Ø±ØŒ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù….</div>
    <button class="btn" type="submit">Ø«Ø¨Øª ØªØ¬Ø±Ø¨Ù‡ Ø´Ù…Ø§</button>
  </div>

        </form>

      </div>
    </div>
  </div>


<script>
  // Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ú©Ù„ÛŒ
  function setRecommend(val){
    document.getElementById('recommendInput').value = val ? 'yes' : 'no';
    document.getElementById('recYes').classList.toggle('ghost', !val);
    document.getElementById('recNo').classList.toggle('ghost', val);
  }

  // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§
  function updateStars(groupName, selectedValue, scoreId, labelId){
    var stars = document.querySelectorAll('input[name="'+groupName+'"]');
    stars.forEach(function(star){
      var starVal = parseInt(star.value,10);
      var svg = star.nextElementSibling.querySelector('svg');
      if(starVal <= selectedValue){
        svg.style.fill = '#f0a63a';
        svg.style.opacity = '1';
        svg.style.transform = 'scale(1.05)';
      } else {
        svg.style.fill = 'var(--blue)';
        svg.style.opacity = '0.12';
        svg.style.transform = 'scale(1)';
      }
    });
    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ØªÙ† Ùˆ Ø¹Ø¯Ø¯ (Ø¨Ø±Ø§ÛŒ overall)
    if(scoreId){
      document.getElementById(scoreId).textContent = selectedValue.toFixed(1);
    }
    if(labelId){
      var label = {
        5:'Ø¹Ø§Ù„ÛŒ',
        4:'Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨',
        3:'Ù…ØªÙˆØ³Ø·',
        2:'Ø¶Ø¹ÛŒÙ',
        1:'Ø®ÛŒÙ„ÛŒ Ø¶Ø¹ÛŒÙ'
      }[selectedValue] || 'Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ';
      document.getElementById(labelId).textContent = label;
    }
  }

  // Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ overall
  document.querySelectorAll('input[name="overall"]').forEach(function(r){
    r.addEventListener('change', function(){
      updateStars('overall', parseInt(this.value,10), 'avgScore', 'overallLabel');
    });
  });

  // Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§
  {% for crit in criteria %}
    document.querySelectorAll('input[name="crit_{{ forloop.counter }}"]').forEach(function(r){
      r.addEventListener('change', function(){
        updateStars('crit_{{ forloop.counter }}', parseInt(this.value,10));
      });
    });
  {% endfor %}

  // Ø¨Ø§Ø± Ù¾ÛŒØ´Ø±ÙØªâ€ŒÙ‡Ø§
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.progress > i').forEach(function(el){
      var w = el.style.width || '0%';
      el.style.transition = 'width 700ms ease';
      el.getBoundingClientRect();
      el.style.width = w;
    });
  });
 document.querySelector('.review-form').addEventListener('submit', function(e){
  e.preventDefault(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÙØ±Ø´

  var form = e.target;
  var data = new FormData(form);

  fetch(form.action, {
    method: 'POST',
    body: data,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if(response.ok){
      alert('Ù†Ø¸Ø± Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯!');
      form.reset(); // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø±Ø³Ø§Ù„
      // Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ Ø±Ùˆ Ù‡Ù… Ø±ÛŒØ³Øª Ú©Ù†ÛŒ
    } else {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø¸Ø±.');
    }
  })
  .catch(err => alert('Ø®Ø·Ø§: ' + err));
});
function setRecommend(val){
  document.getElementById('recommendInput').value = val ? 'yes' : 'no';
  
  // Ø³Øª Ú©Ø±Ø¯Ù† radio ÙˆØ§Ù‚Ø¹ÛŒ
  document.getElementById('recYesInput').checked = val;
  document.getElementById('recNoInput').checked = !val;

  // ØªØºÛŒÛŒØ± Ø¸Ø§Ù‡Ø± Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
  document.getElementById('recYes').classList.toggle('ghost', !val);
  document.getElementById('recNo').classList.toggle('ghost', val);
}
</script>


{% endblock content %}